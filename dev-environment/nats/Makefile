# HYDRA Development NATS Environment
# Provides production-parity localhost:4222 for development

.PHONY: help start stop restart status test logs clean monitor setup install health install-docker quick-start

# Default target
help: ## Show this help message
	@echo "ğŸš€ HYDRA Development NATS Environment"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Provides localhost:4222 NATS that matches HYDRA production"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

install-docker: ## Install Docker and prerequisites
	@echo "ğŸš€ Installing Docker and prerequisites for HYDRA development..."
	@if [ "$(uname)" = "Darwin" ]; then \
		echo "ğŸ“¦ Installing for macOS..."; \
		if ! command -v brew >/dev/null 2>&1; then \
			echo "Installing Homebrew..."; \
			/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; \
		fi; \
		if ! command -v docker >/dev/null 2>&1; then \
			echo "Installing Docker Desktop..."; \
			brew install --cask docker; \
			echo "âš ï¸  Please start Docker Desktop manually and run 'make quick-start' again"; \
			exit 1; \
		fi; \
		brew install git make curl jq 2>/dev/null || true; \
	elif [ -f /etc/debian_version ]; then \
		echo "ğŸ“¦ Installing for Ubuntu/Debian..."; \
		sudo apt update; \
		if ! command -v docker >/dev/null 2>&1; then \
			sudo apt install -y docker.io docker-compose git make curl jq; \
			sudo systemctl start docker; \
			sudo systemctl enable docker; \
			sudo usermod -aG docker $USER; \
			echo "âš ï¸  Please log out and back in, then run 'make quick-start'"; \
			exit 1; \
		fi; \
	elif [ -f /etc/redhat-release ]; then \
		echo "ğŸ“¦ Installing for Red Hat/CentOS/Fedora..."; \
		if command -v dnf >/dev/null 2>&1; then \
			sudo dnf install -y docker docker-compose git make curl jq; \
		else \
			sudo yum install -y docker docker-compose git make curl jq; \
		fi; \
		sudo systemctl start docker; \
		sudo systemctl enable docker; \
		sudo usermod -aG docker $USER; \
		echo "âš ï¸  Please log out and back in, then run 'make quick-start'"; \
		exit 1; \
	else \
		echo "âŒ Unsupported OS. Please install Docker manually"; \
		exit 1; \
	fi
	@echo "âœ… Prerequisites installed successfully!"

quick-start: ## One-command setup: install prerequisites and start HYDRA environment
	@echo "ğŸš€ HYDRA Development Environment - Quick Start"
	@echo "=============================================="
	@echo ""
	@if ! docker info >/dev/null 2>&1; then \
		echo "Docker not found or not running. Installing prerequisites..."; \
		$(MAKE) install-docker; \
	fi
	@echo "ğŸ¯ Starting HYDRA development environment..."
	@$(MAKE) start
	@echo ""
	@echo "ğŸ‰ SUCCESS! HYDRA Development Environment is Ready!"
	@echo "=================================================="
	@echo ""
	@echo "ğŸ¯ NATS Server:     nats://localhost:4222"
	@echo "ğŸ“Š Monitoring:      http://localhost:8222"
	@echo "ğŸ©º Health Check:    http://localhost:8222/healthz"
	@echo ""
	@echo "ğŸ‘¤ User:            app-limited"
	@echo "ğŸ”‘ Password:        dev-password-change-in-production"
	@echo ""
	@echo "Next steps:"
	@echo "  make test          # Test connectivity"
	@echo "  make info          # Show connection details"
	@echo "  make install-cli   # Install NATS CLI (optional)"
	@echo ""
	@echo "ğŸ¯ Your applications can now connect to localhost:4222"
	@echo "   This works exactly the same on HYDRA production units!"
setup: ## Initial setup - prepare environment (use quick-start for full setup)
	@echo "ğŸ“¥ Setting up HYDRA development environment..."
	@if [ ! -f docker-compose.yml ]; then \
		echo "âŒ docker-compose.yml not found. Please ensure you're in the hydra-public/dev-environment/nats directory"; \
		exit 1; \
	fi
	@mkdir -p nats/logs
	@echo "âœ… Setup complete"
	@echo "ğŸ’¡ Use 'make quick-start' for automatic Docker installation and startup"

install: setup ## Install (alias for setup)

start: ## Start HYDRA development NATS server
	@echo "ğŸš€ Starting HYDRA Development NATS Environment..."
	@if ! docker info > /dev/null 2>&1; then \
		echo "âŒ Docker is not running. Please start Docker first."; \
		exit 1; \
	fi
	@echo "ğŸ“¡ Starting NATS server..."
	@docker-compose up -d nats
	@echo "â³ Waiting for NATS to be ready..."
	@timeout=30; \
	while [ $$timeout -gt 0 ]; do \
		if curl -f http://localhost:8222/healthz > /dev/null 2>&1; then \
			echo "âœ… NATS is ready on localhost:4222"; \
			break; \
		fi; \
		sleep 1; \
		timeout=$$((timeout-1)); \
	done; \
	if [ $$timeout -eq 0 ]; then \
		echo "âŒ NATS failed to start properly"; \
		docker-compose logs nats; \
		exit 1; \
	fi
	@echo ""
	@echo "ğŸ¯ HYDRA Development Environment Ready!"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "NATS Client URL:    nats://localhost:4222"
	@echo "NATS Monitoring:    http://localhost:8222"
	@echo "Health Check:       http://localhost:8222/healthz"
	@echo ""
	@echo "Credentials:"
	@echo "  User: app-limited"
	@echo "  Pass: dev-password-change-in-production"
	@echo ""
	@echo "ğŸ¯ Your application can now connect to localhost:4222"
	@echo "   This matches exactly how it works on HYDRA units!"

stop: ## Stop HYDRA development NATS server
	@echo "ğŸ›‘ Stopping HYDRA Development NATS..."
	@if docker compose version >/dev/null 2>&1; then \
		docker compose down; \
	elif command -v docker-compose >/dev/null 2>&1; then \
		docker-compose down; \
	else \
		echo "âŒ Neither 'docker compose' nor 'docker-compose' found"; \
		exit 1; \
	fi
	@echo "âœ… NATS stopped"

restart: stop start ## Restart NATS server

status: ## Show status of HYDRA development environment
	@echo "ğŸ“Š HYDRA Development Environment Status"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@if docker compose version >/dev/null 2>&1; then \
		if docker compose ps | grep -q "hydra-dev-nats.*Up"; then \
			echo "âœ… NATS Server: Running"; \
			if curl -f http://localhost:8222/healthz > /dev/null 2>&1; then \
				echo "âœ… Health Check: Passing"; \
			else \
				echo "âŒ Health Check: Failing"; \
			fi; \
		else \
			echo "âŒ NATS Server: Not Running"; \
		fi; \
		echo ""; \
		docker compose ps; \
	elif command -v docker-compose >/dev/null 2>&1; then \
		if docker-compose ps | grep -q "hydra-dev-nats.*Up"; then \
			echo "âœ… NATS Server: Running"; \
			if curl -f http://localhost:8222/healthz > /dev/null 2>&1; then \
				echo "âœ… Health Check: Passing"; \
			else \
				echo "âŒ Health Check: Failing"; \
			fi; \
		else \
			echo "âŒ NATS Server: Not Running"; \
		fi; \
		echo ""; \
		docker-compose ps; \
	else \
		echo "âŒ Neither 'docker compose' nor 'docker-compose' found"; \
	fi

health: ## Check NATS health and connectivity
	@echo "ğŸ©º HYDRA Development NATS Health Check"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@if ! curl -f http://localhost:8222/varz > /dev/null 2>&1; then \
		echo "âŒ NATS server not responding on localhost:8222"; \
		echo "ğŸ’¡ Run: make start"; \
		exit 1; \
	fi
	@echo "âœ… NATS server is running on localhost:4222"
	@echo "âœ… HTTP monitoring available on localhost:8222"
	@if command -v nats >/dev/null 2>&1; then \
		echo "ğŸ“¡ Testing publish/subscribe..."; \
		nats --server localhost:4222 --user app-limited --password dev-password-change-in-production \
			pub app.test.health "Health check from make" > /dev/null 2>&1 && \
			echo "âœ… Message publishing works" || \
			echo "âŒ Message publishing failed"; \
	else \
		echo "ğŸ’¡ Install nats CLI for advanced testing:"; \
		echo "   go install github.com/nats-io/natscli/nats@latest"; \
	fi

test: health ## Test NATS connection and functionality
	@echo ""
	@echo "ğŸ§ª Running Connection Tests..."
	@if command -v nats >/dev/null 2>&1; then \
		echo "ğŸ“Š NATS Server Info:"; \
		nats --server localhost:4222 --user app-limited --password dev-password-change-in-production \
			server info 2>/dev/null || echo "âŒ Failed to get server info"; \
	fi
	@echo ""
	@echo "ğŸ¯ Development environment ready for your application!"

logs: ## Show NATS server logs
	@echo "ğŸ“‹ HYDRA Development NATS Logs"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@if docker compose version >/dev/null 2>&1; then \
		docker compose logs -f nats; \
	elif command -v docker-compose >/dev/null 2>&1; then \
		docker-compose logs -f nats; \
	else \
		echo "âŒ Neither 'docker compose' nor 'docker-compose' found"; \
	fi

monitor: ## Start monitoring dashboard
	@echo "ğŸ“Š Starting HYDRA Development Monitoring..."
	@if docker compose version >/dev/null 2>&1; then \
		docker compose --profile monitoring up -d; \
	elif command -v docker-compose >/dev/null 2>&1; then \
		docker-compose --profile monitoring up -d; \
	else \
		echo "âŒ Neither 'docker compose' nor 'docker-compose' found"; \
		exit 1; \
	fi
	@echo "âœ… Monitoring dashboard available at: http://localhost:7777"
	@echo "âœ… NATS monitoring at: http://localhost:8222"

clean: stop ## Stop and remove all containers and volumes
	@echo "ğŸ§¹ Cleaning up HYDRA development environment..."
	@if docker compose version >/dev/null 2>&1; then \
		docker compose down -v --remove-orphans; \
		docker compose --profile monitoring down -v --remove-orphans 2>/dev/null || true; \
	elif command -v docker-compose >/dev/null 2>&1; then \
		docker-compose down -v --remove-orphans; \
		docker-compose --profile monitoring down -v --remove-orphans 2>/dev/null || true; \
	else \
		echo "âŒ Neither 'docker compose' nor 'docker-compose' found"; \
		exit 1; \
	fi
	@echo "âœ… Cleanup complete"

# Development workflow targets
dev-start: start ## Start development environment (alias for start)

dev-test: start test ## Start environment and run tests

dev-stop: stop ## Stop development environment (alias for stop)

# Quick access to common info
info: ## Show connection information
	@echo "ğŸ¯ HYDRA Development Environment Info"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "NATS URL:     nats://localhost:4222"
	@echo "Monitor:      http://localhost:8222"
	@echo "Health:       http://localhost:8222/healthz"
	@echo ""
	@echo "Authentication:"
	@echo "  User:       app-limited"
	@echo "  Password:   dev-password-change-in-production"
	@echo ""
	@echo "Subject Namespace:"
	@echo "  Your App:   app.yourapp.*"
	@echo "  NimsForest: app.nimsforest.*"
	@echo "  Telemetry:  telemetry.*"

# Advanced targets
pull: ## Pull latest NATS images
	@echo "ğŸ“¥ Pulling latest NATS images..."
	@docker-compose pull
	@echo "âœ… Images updated"

update: pull restart ## Update NATS images and restart

# Development debugging
debug: ## Show debug information
	@echo "ğŸ” HYDRA Development Debug Information"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "Docker Status:"
	@docker --version
	@docker info --format "  Version: {{.ServerVersion}}"
	@echo ""
	@echo "Container Status:"
	@docker-compose ps
	@echo ""
	@echo "Network Status:"
	@netstat -an | grep ":4222\|:6222\|:8222" || echo "  No NATS ports found"
	@echo ""
	@echo "Environment Files:"
	@ls -la nats/ 2>/dev/null || echo "  nats/ directory not found"

# Help with NATS CLI installation
install-cli: ## Install NATS CLI tool
	@echo "ğŸ“¦ Installing NATS CLI tool..."
	@if command -v go >/dev/null 2>&1; then \
		go install github.com/nats-io/natscli/nats@latest; \
		echo "âœ… NATS CLI installed successfully"; \
		echo "ğŸ’¡ Make sure $(go env GOPATH)/bin is in your PATH"; \
	else \
		echo "âŒ Go not found. Please install Go first:"; \
		echo "   https://golang.org/doc/install"; \
	fi
